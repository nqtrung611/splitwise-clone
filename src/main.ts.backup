import './style.css';
import { User, Expense, Settlement } from './types';
import { calculateBalances, formatCurrency } from './utils';
import { ExpenseCard } from './components/ExpenseCard';
import { BalanceCard } from './components/BalanceCard';
import { AddExpenseModal } from './components/AddExpenseModal';
import { SettlementCard } from './components/SettlementCard';
import { LoginModal } from './components/LoginModal';
import { UserManagementModal } from './components/UserManagementModal';
import { AuthService } from './services/AuthService';
import { firebaseService } from './services/FirebaseService';

// Debug: Check if main.ts loads
console.log('ğŸš€ğŸš€ğŸš€ NUCLEAR VERSION v5.0.0-ISACTIVE-BLOCK ğŸš€ğŸš€ğŸš€');
console.log('ğŸš€ MAIN.TS LOADED SUCCESSFULLY');
console.log('ğŸš€ Date:', new Date().toISOString());
document.title = 'Splitwise Clone v5.0.0-NUCLEAR'; // VISUAL INDICATOR

// Firebase-only mode - no localStorage fallback
console.log('=== FIREBASE ONLY MODE - NUCLEAR ISACTIVE CHECK ===');
console.log('ğŸ”¥ Build timestamp:', new Date().toISOString());
(window as any).NUCLEAR_VERSION = 'v5.0.0-ISACTIVE-BLOCK'; // GLOBAL INDICATOR
console.log('ğŸ”¥ Version: v3.0.0-apiservice-disabled');
console.log('ğŸ”¥ Force new build hash:', Math.random());
console.log('All data stored in Firestore');
console.log('============================');

class SplitwiseApp {
  private users: User[] = [];
  private expenses: Expense[] = [];
  private settlements: Settlement[] = [];

  private currentUser: User | null = null;
  private addExpenseModal: AddExpenseModal;
  private authService: AuthService;
  // private firebaseService = firebaseService; // Not used directly
  private currentFilter = '';

  constructor() {
    this.authService = new AuthService();
    const authState = this.authService.getCurrentAuth();
    
    if (authState.isAuthenticated && authState.currentUser) {
      this.currentUser = authState.currentUser;
      this.initializeData();
    }
    
    this.addExpenseModal = new AddExpenseModal(this.users, this.currentUser, (expense: Expense) => this.addExpense(expense));
    this.render();
    this.setupEventListeners();
    
    // Add global delete function for expense cards
    (window as any).deleteExpense = (expenseId: string) => this.deleteExpense(expenseId);
    

    
    // Add global edit user function
    (window as any).editUser = (userId: string) => this.editUser(userId);
    
    // Add global confirm settlement function
    (window as any).confirmSettlement = (settlementId: string) => {
      this.confirmSettlement(settlementId).catch(error => {
        alert('âŒ Lá»—i khi xÃ¡c nháº­n thanh toÃ¡n: ' + (error instanceof Error ? error.message : error));
      });
    };

    // Add global confirm multiple settlements function
    (window as any).confirmMultipleSettlements = (settlementIds: string) => {
      this.confirmMultipleSettlements(settlementIds).catch(error => {
        alert('âŒ Lá»—i khi xÃ¡c nháº­n thanh toÃ¡n: ' + (error instanceof Error ? error.message : error));
      });
    };
  }

  private async initializeData(): Promise<void> {
    try {
      // Load users from API
      this.users = await this.authService.getAllUsers();
      this.users = this.users.filter((u: User) => u.isActive);
      
      // Load expenses from API
      this.expenses = await this.loadExpenses();
      
      // Load settlements from Firebase
      this.settlements = await this.loadSettlements();
    } catch (error) {
      console.error('Failed to initialize data:', error);
      // No fallback - Firebase only
      throw error;
    }
  }

  private async loadExpenses(): Promise<Expense[]> {
    try {
      return await firebaseService.getExpenses();
    } catch (error) {
      console.error('Failed to load expenses from Firebase:', error);
      throw error; // Force Firebase usage only
    }
  }

  private async loadSettlements(): Promise<Settlement[]> {
    try {
      return await firebaseService.getSettlements();
    } catch (error) {
      console.error('Failed to load settlements from Firebase:', error);
      return []; // Return empty array if fails
    }
  }







  private render() {
    const app = document.getElementById('app')!;
    
    if (!this.currentUser) {
      app.innerHTML = this.renderLoginScreen();
      return;
    }
    
    app.innerHTML = `
      <div class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
          <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <h1 class="text-3xl font-bold text-splitwise-green">ğŸ’° Splitwise Clone</h1>
                <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded-full font-medium">
                  Beta v1.0
                </span>
              </div>
              <div class="flex items-center space-x-4">
                ${this.currentUser.role === 'admin' ? `
                  <button id="userManagementBtn" class="btn-secondary flex items-center space-x-2">
                    <span>ğŸ‘¥</span>
                    <span>Quáº£n lÃ½ User</span>
                  </button>
                ` : ''}
                <div class="text-right">
                  <div class="text-sm text-gray-500">Xin chÃ o,</div>
                  <div class="font-semibold text-gray-800">${this.currentUser.name}</div>
                  ${this.currentUser.role === 'admin' ? '<div class="text-xs text-red-600">ğŸ‘‘ Admin</div>' : ''}
                </div>
                <button id="addExpenseBtn" class="btn-primary flex items-center space-x-2">
                  <span>â•</span>
                  <span>ThÃªm chi phÃ­</span>
                </button>
                <button id="logoutBtn" class="btn-secondary flex items-center space-x-2">
                  <span>ğŸšª</span>
                  <span>ÄÄƒng xuáº¥t</span>
                </button>
              </div>
            </div>
          </div>
        </header>

        <div class="max-w-6xl mx-auto px-4 py-8">
          <!-- Stats Overview -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            ${this.renderStatsCards()}
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-4 lg:grid-cols-2 gap-6">
            <!-- Balance Summary -->
            <div class="lg:col-span-1">
              <div id="balanceSection">
                ${this.renderBalanceSection()}
              </div>
            </div>

            <!-- Settlement Suggestions -->
            <div class="lg:col-span-1">
              <div id="settlementSection">
                ${this.renderSettlementSection()}
              </div>
            </div>

            <!-- Expenses List - Takes full width on smaller screens -->
            <div class="xl:col-span-2 lg:col-span-2 col-span-1">
              <div class="card">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                  <h2 class="text-xl font-semibold flex items-center">
                    ğŸ“‹ Danh sÃ¡ch chi phÃ­
                    <span class="ml-2 text-sm font-normal text-gray-500">
                      (${this.getFilteredExpenses().length} chi phÃ­)
                    </span>
                  </h2>
                  <div class="flex items-center space-x-3">
                    <select id="filterCategory" class="input-field w-auto text-sm">
                      <option value="">ğŸ·ï¸ Táº¥t cáº£ danh má»¥c</option>
                      <option value="food">ğŸ½ï¸ Ä‚n uá»‘ng</option>
                      <option value="transportation">ğŸš— Di chuyá»ƒn</option>
                      <option value="accommodation">ğŸ  LÆ°u trÃº</option>
                      <option value="entertainment">ğŸ‰ Giáº£i trÃ­</option>
                      <option value="shopping">ğŸ›ï¸ Mua sáº¯m</option>
                      <option value="utilities">âš¡ Tiá»‡n Ã­ch</option>
                      <option value="other">ğŸ“¦ KhÃ¡c</option>
                    </select>
                    <button id="clearFilter" class="text-sm text-gray-500 hover:text-gray-700 ${this.currentFilter ? '' : 'hidden'}">
                      âŒ XÃ³a bá»™ lá»c
                    </button>
                  </div>
                </div>
                <div id="expensesList">
                  ${this.renderExpensesList()}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Expense Modal -->
        ${this.addExpenseModal.render()}
      </div>
    `;

    // Setup modal event listeners after rendering
    this.addExpenseModal.setupEventListeners();
  }

  private renderLoginScreen(): string {
    return `
      <div class="min-h-screen bg-gray-50 flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-splitwise-green mb-2">ğŸ’° Splitwise Clone</h1>
            <p class="text-gray-600">á»¨ng dá»¥ng chia sáº» chi phÃ­ thÃ´ng minh</p>
          </div>
          
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-center mb-6">ğŸ” ÄÄƒng nháº­p Ä‘á»ƒ tiáº¿p tá»¥c</h2>
            
            <div class="space-y-4">
              <button id="showLoginBtn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                ÄÄƒng nháº­p
              </button>
            </div>
          </div>
          
          <div class="mt-6 text-center text-sm text-gray-500">
            <p>âœ¨ Chia sáº» chi phÃ­ dá»… dÃ ng cÃ¹ng báº¡n bÃ¨</p>
            <p>ğŸ“Š Theo dÃµi sá»‘ dÆ° vÃ  thanh toÃ¡n thÃ´ng minh</p>
          </div>
        </div>
      </div>
    `;
  }

  private renderStatsCards(): string {
    if (!this.currentUser) return '';
    
    const totalExpenses = this.expenses.reduce((sum, exp) => sum + exp.amount, 0);
    const userExpenses = this.expenses.filter(exp => exp.paidBy === this.currentUser!.id);
    const userPaidTotal = userExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    const balances = calculateBalances(this.expenses, this.users);
    const currentBalance = balances[this.currentUser.id];
    const netBalance = currentBalance ? currentBalance.totalOwed - currentBalance.totalOwes : 0;

    return `
      <div class="card text-center">
        <div class="text-2xl mb-2">ğŸ’°</div>
        <div class="text-2xl font-bold text-gray-800">${formatCurrency(totalExpenses)}</div>
        <div class="text-sm text-gray-600">Tá»•ng chi phÃ­</div>
      </div>
      
      <div class="card text-center">
        <div class="text-2xl mb-2">ğŸ¯</div>
        <div class="text-2xl font-bold text-gray-800">${formatCurrency(userPaidTotal)}</div>
        <div class="text-sm text-gray-600">Báº¡n Ä‘Ã£ tráº£</div>
      </div>
      
      <div class="card text-center">
        <div class="text-2xl mb-2">${netBalance >= 0 ? 'ğŸ’š' : 'ğŸ’”'}</div>
        <div class="text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
          ${netBalance >= 0 ? '+' : ''}${formatCurrency(netBalance)}
        </div>
        <div class="text-sm text-gray-600">Sá»‘ dÆ° cá»§a báº¡n</div>
      </div>
    `;
  }

  private renderBalanceSection(): string {
    if (!this.currentUser) return '';
    
    const balances = this.calculateBalancesWithSettlements();
    const currentUserBalance = balances[this.currentUser.id];

    if (!currentUserBalance) {
      return `
        <div class="card text-center py-8">
          <div class="text-4xl mb-4">ğŸ‰</div>
          <h2 class="text-xl font-semibold mb-2">ChÆ°a cÃ³ giao dá»‹ch nÃ o</h2>
          <p class="text-gray-500">ThÃªm chi phÃ­ Ä‘áº§u tiÃªn Ä‘á»ƒ báº¯t Ä‘áº§u!</p>
        </div>
      `;
    }

    const balanceCard = new BalanceCard(currentUserBalance, this.users, balances);
    return balanceCard.render();
  }

  private renderSettlementSection(): string {
    const settlementCard = new SettlementCard(this.users, this.settlements, this.currentUser);
    return settlementCard.render();
  }

  private renderExpensesList(): string {
    const filteredExpenses = this.getFilteredExpenses();
    
    if (filteredExpenses.length === 0) {
      return `
        <div class="text-center py-12">
          <div class="text-4xl mb-4">ğŸ“</div>
          <h3 class="text-lg font-medium text-gray-800 mb-2">
            ${this.currentFilter ? 'KhÃ´ng cÃ³ chi phÃ­ nÃ o trong danh má»¥c nÃ y' : 'ChÆ°a cÃ³ chi phÃ­ nÃ o'}
          </h3>
          <p class="text-gray-500 mb-4">
            ${this.currentFilter ? 'Thá»­ chá»n danh má»¥c khÃ¡c hoáº·c thÃªm chi phÃ­ má»›i' : 'Báº¯t Ä‘áº§u báº±ng cÃ¡ch thÃªm chi phÃ­ Ä‘áº§u tiÃªn'}
          </p>
          <button onclick="document.getElementById('addExpenseBtn').click()" class="btn-primary">
            â• ThÃªm chi phÃ­ ngay
          </button>
        </div>
      `;
    }

    return filteredExpenses.map(expense => {
      const expenseCard = new ExpenseCard(expense, this.users, this.currentUser, () => this.deleteExpense(expense.id));
      return expenseCard.render();
    }).join('');
  }

  private getFilteredExpenses(): Expense[] {
    if (!this.currentFilter) return this.expenses;
    return this.expenses.filter(expense => expense.category === this.currentFilter);
  }

  private setupEventListeners() {
    // Login button (if not authenticated)
    document.getElementById('showLoginBtn')?.addEventListener('click', () => {
      this.showLoginModal();
    });

    // Logout button (if authenticated)
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
      this.logout();
    });

    // User management button (admin only)
    document.getElementById('userManagementBtn')?.addEventListener('click', () => {
      this.showUserManagementModal();
    });

    // Add expense button
    document.getElementById('addExpenseBtn')?.addEventListener('click', () => {
      this.addExpenseModal.show();
    });

    // Filter expenses
    document.getElementById('filterCategory')?.addEventListener('change', (e) => {
      this.currentFilter = (e.target as HTMLSelectElement).value;
      this.updateExpensesList();
      this.updateFilterControls();
    });

    // Clear filter
    document.getElementById('clearFilter')?.addEventListener('click', () => {
      this.currentFilter = '';
      const filterSelect = document.getElementById('filterCategory') as HTMLSelectElement;
      if (filterSelect) filterSelect.value = '';
      this.updateExpensesList();
      this.updateFilterControls();
    });
  }

  private async addExpense(expense: Expense) {
    try {
      console.log('ğŸ”¥ğŸ”¥ğŸ”¥ Main.ts: addExpense called with:', expense);
      console.log('ğŸ”¥ Main.ts: Calling firebaseService.createExpense...');
      const newExpense = await firebaseService.createExpense(expense);
      console.log('ğŸ”¥ Main.ts: Firebase returned:', newExpense);
      this.expenses.unshift(newExpense);
      
      // Táº¡o settlements tá»« expense má»›i
      await this.createSettlementsFromExpense(newExpense);
      
      // Reload settlements from Firebase Ä‘á»ƒ hiá»ƒn thá»‹ má»›i
      // Reload settlements from Firebase Ä‘á»ƒ hiá»ƒn thá»‹ má»›i
      console.log('ğŸ”¥ Reloading settlements from Firebase...');
      this.settlements = await this.loadSettlements();
      console.log('ğŸ”¥ Current settlements after creation:', this.settlements.length);
      
      // Debug: In ra táº¥t cáº£ settlements vÃ  relatedExpenses
      this.settlements.forEach((settlement, index) => {
        console.log(`ğŸ” Settlement ${index + 1}:`, {
          id: settlement.id,
          from: settlement.from,
          to: settlement.to,
          amount: settlement.amount,
          relatedExpenses: settlement.relatedExpenses,
          description: settlement.description
        });
      });
      
      this.updateAll();
      console.log('ğŸ”¥ Main.ts: Expense added successfully');
    } catch (error) {
      console.error('âŒ Failed to add expense to Firebase:', error);
      alert('âŒ Lá»—i khi lÆ°u expense: ' + (error instanceof Error ? error.message : error));
      throw error; // Don't fallback
    }
  }

  private async createSettlementsFromExpense(expense: Expense) {
    try {
      console.log('ğŸ”¥ğŸ”¥ğŸ”¥ Creating settlements from expense:', expense.id);
      console.log('ğŸ”¥ Expense data:', expense);
      console.log('ğŸ”¥ splitBetween:', expense.splitBetween);
      
      const paidByUser = expense.paidBy;
      console.log('ğŸ”¥ Paid by user ID:', paidByUser);
      
      // Táº¡o settlement cho má»—i ngÆ°á»i ná»£ tiá»n
      for (const split of expense.splitBetween) {
        console.log('ğŸ”¥ Processing split:', split);
        
        // Bá» qua náº¿u ngÆ°á»i tráº£ vÃ  ngÆ°á»i ná»£ lÃ  cÃ¹ng 1 ngÆ°á»i
        if (split.userId === paidByUser) {
          console.log('ğŸ”¥ Skipping - same person paid and owes:', split.userId);
          continue;
        }
        
        const settlement: Settlement = {
          id: `settlement_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          from: split.userId, // NgÆ°á»i ná»£ tiá»n
          to: paidByUser, // NgÆ°á»i Ä‘Ã£ tráº£
          amount: split.amount || 0,
          description: `Thanh toÃ¡n cho: ${expense.description}`,
          isSettled: false,
          createdAt: new Date(),
          relatedExpenses: [expense.id || '']
        };
        
        console.log('ğŸ”¥ Creating settlement:', settlement);
        
        try {
          await firebaseService.saveSettlement(settlement);
          console.log('âœ… Settlement saved successfully:', settlement.id);
        } catch (settlementError) {
          console.error('âŒ Failed to save individual settlement:', settlementError);
          console.error('âŒ Settlement data:', settlement);
          throw settlementError; // Re-throw Ä‘á»ƒ debug
        }
      }
      
      console.log('âœ… All settlements created successfully');
    } catch (error) {
      console.error('âŒâŒâŒ Failed to create settlements:', error);
      console.error('âŒ Error type:', typeof error);
      console.error('âŒ Error message:', error instanceof Error ? error.message : error);
      console.error('âŒ Full error:', error);
      // Throw error Ä‘á»ƒ user biáº¿t cÃ³ lá»—i
      throw error;
    }
  }

  private async deleteExpense(expenseId: string) {
    // Kiá»ƒm tra quyá»n admin
    if (!this.currentUser || this.currentUser.role !== 'admin') {
      alert('âš ï¸ Chá»‰ admin má»›i cÃ³ thá»ƒ xÃ³a chi phÃ­!');
      return;
    }

    if (confirm('ğŸ—‘ï¸ Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a chi phÃ­ nÃ y khÃ´ng? CÃ¡c gá»£i Ã½ thanh toÃ¡n liÃªn quan cÅ©ng sáº½ bá»‹ xÃ³a.')) {
      try {
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ START DELETION PROCESS:', expenseId);
        
        // BÆ¯á»šC 1: Kiá»ƒm tra expense cÃ³ tá»“n táº¡i khÃ´ng
        console.log('ğŸ”¥ STEP 1: Checking if expense exists...');
        const expenseExists = this.expenses.some(exp => exp.id === expenseId);
        if (!expenseExists) {
          console.log('âš ï¸ Expense Ä‘Ã£ khÃ´ng tá»“n táº¡i trong local data:', expenseId);
          alert('âš ï¸ Chi phÃ­ nÃ y Ä‘Ã£ Ä‘Æ°á»£c xÃ³a rá»“i!');
          return;
        }

        // BÆ¯á»šC 2: TÃ¬m vÃ  log chi tiáº¿t settlements cáº§n xÃ³a
        console.log('ğŸ”¥ STEP 2: Finding related settlements...');
        console.log('ğŸ”¥ Current settlements:', this.settlements.length);
        
        const settlementsToDelete = this.settlements.filter(settlement => {
          console.log('ğŸ” Checking settlement:', settlement.id, 'relatedExpenses:', settlement.relatedExpenses);
          const isRelated = settlement.relatedExpenses && settlement.relatedExpenses.includes(expenseId);
          console.log('ğŸ” Is related to expense?', isRelated);
          return isRelated;
        });
        
        console.log('ğŸ”¥ Found settlements to delete:', settlementsToDelete.length);
        settlementsToDelete.forEach((settlement, index) => {
          console.log(`ğŸ”¥ Settlement ${index + 1}:`, {
            id: settlement.id,
            from: settlement.from,
            to: settlement.to,
            amount: settlement.amount,
            relatedExpenses: settlement.relatedExpenses
          });
        });
        
        // BÆ¯á»šC 3: XÃ³a expense tá»« Firebase vá»›i force check
        console.log('ğŸ”¥ STEP 3: Deleting expense from Firebase...');
        
        // Kiá»ƒm tra trÆ°á»›c khi xÃ³a
        console.log('ğŸ” Pre-delete check: Getting current expenses from Firebase...');
        const preDeleteExpenses = await firebaseService.getExpenses();
        const expenseExistsInFirebase = preDeleteExpenses.some(exp => exp.id === expenseId);
        console.log('ï¿½ Expense exists in Firebase:', expenseExistsInFirebase);
        
        if (!expenseExistsInFirebase) {
          console.log('âš ï¸ Expense khÃ´ng tá»“n táº¡i trong Firebase, cÃ³ thá»ƒ Ä‘Ã£ bá»‹ xÃ³a');
          // Váº«n tiáº¿p tá»¥c Ä‘á»ƒ xÃ³a settlements vÃ  sync data
        } else {
          await firebaseService.deleteExpense(expenseId);
          console.log('âœ… STEP 3: Expense deleted from Firebase successfully');
        }
        
        // BÆ¯á»šC 4: Verification - Äáº£m báº£o expense Ä‘Ã£ bá»‹ xÃ³a tháº­t sá»±  
        console.log('ğŸ” STEP 4: Verifying expense deletion...');
        await new Promise(resolve => setTimeout(resolve, 1500)); // Wait 1.5 seconds for Firebase sync
        
        let verificationAttempts = 0;
        const maxVerificationAttempts = 3;
        let stillExists = true;
        
        while (stillExists && verificationAttempts < maxVerificationAttempts) {
          verificationAttempts++;
          console.log(`ğŸ” Verification attempt ${verificationAttempts}/${maxVerificationAttempts}...`);
          
          const remainingExpenses = await firebaseService.getExpenses();
          stillExists = remainingExpenses.some(exp => exp.id === expenseId);
          
          console.log(`ğŸ” Attempt ${verificationAttempts}: Expense still exists?`, stillExists);
          
          if (stillExists && verificationAttempts < maxVerificationAttempts) {
            console.log(`â³ Expense váº«n cÃ²n, Ä‘á»£i thÃªm ${verificationAttempts * 1000}ms...`);
            await new Promise(resolve => setTimeout(resolve, verificationAttempts * 1000));
          }
        }
        
        if (stillExists) {
          throw new Error(`âŒ CRITICAL: Expense ${expenseId} váº«n tá»“n táº¡i sau ${maxVerificationAttempts} láº§n kiá»ƒm tra! CÃ³ thá»ƒ cÃ³ váº¥n Ä‘á» vá»›i quyá»n Firebase.`);
        }
        console.log('âœ… STEP 4: Expense confirmed deleted from Firebase');
        
        // BÆ¯á»šC 5: BÃ¢y giá» má»›i xÃ³a settlements (vÃ¬ expense Ä‘Ã£ cháº¯c cháº¯n bá»‹ xÃ³a)
        console.log('ğŸ”¥ STEP 5: Deleting related settlements...');
        
        if (settlementsToDelete.length === 0) {
          console.log('â„¹ï¸ No settlements to delete for this expense');
        } else {
          console.log(`ğŸ”¥ Deleting ${settlementsToDelete.length} settlements...`);
          
          for (let i = 0; i < settlementsToDelete.length; i++) {
            const settlement = settlementsToDelete[i];
            console.log(`ğŸ”¥ Deleting settlement ${i + 1}/${settlementsToDelete.length}:`, settlement.id);
            
            try {
              await firebaseService.deleteSettlement(settlement.id);
              console.log(`âœ… Settlement ${i + 1} deleted successfully:`, settlement.id);
            } catch (settlementError) {
              console.error(`âŒ Failed to delete settlement ${i + 1}:`, settlement.id, settlementError);
              // KhÃ´ng throw error, tiáº¿p tá»¥c xÃ³a settlements khÃ¡c
            }
          }
        }
        console.log('âœ… STEP 5: Settlement deletion process completed');
        
        // BÆ¯á»šC 6: Cáº­p nháº­t local data báº±ng cÃ¡ch reload tá»« Firebase
        console.log('ğŸ”¥ STEP 6: Reloading all data from Firebase...');
        this.expenses = await this.loadExpenses(); // Reload tá»« Firebase
        this.settlements = await this.loadSettlements(); // Reload tá»« Firebase
        
        // Final verification: Äáº£m báº£o cáº£ expense vÃ  settlements Ä‘á»u Ä‘Ã£ bá»‹ xÃ³a
        const expenseStillInLocal = this.expenses.some(exp => exp.id === expenseId);
        const settlementsStillInLocal = this.settlements.filter(s => 
          s.relatedExpenses && s.relatedExpenses.includes(expenseId)
        );
        
        if (expenseStillInLocal) {
          console.error('âŒ CRITICAL ERROR: Expense váº«n cÃ²n trong local data sau reload!');
          throw new Error('Expense deletion verification failed');
        }
        
        if (settlementsStillInLocal.length > 0) {
          console.error('âŒ WARNING: Some settlements váº«n cÃ²n trong local data:', settlementsStillInLocal);
        }
        
        console.log('âœ… STEP 6: Local data updated successfully');
        
        // BÆ¯á»šC 7: Cáº­p nháº­t UI
        console.log('ğŸ”¥ STEP 7: Updating UI...');
        this.updateAll();
        console.log('âœ… STEP 7: UI updated successfully');
        
        alert('âœ… ÄÃ£ xÃ³a chi phÃ­ vÃ  gá»£i Ã½ thanh toÃ¡n thÃ nh cÃ´ng!');
        console.log('ğŸ‰ ALL STEPS COMPLETED SUCCESSFULLY');
        
      } catch (error) {
        console.error('âŒâŒâŒ DELETION FAILED:', error);
        console.error('âŒ Error type:', typeof error);
        console.error('âŒ Error message:', error instanceof Error ? error.message : error);
        console.error('âŒ Full error object:', error);
        
        // ThÃ´ng bÃ¡o lá»—i chi tiáº¿t
        const errorMessage = error instanceof Error ? error.message : String(error);
        if (errorMessage.includes('CRITICAL')) {
          alert('âŒ Lá»–I NGHIÃŠM TRá»ŒNG: ' + errorMessage + '\n\nVui lÃ²ng thá»­ láº¡i hoáº·c liÃªn há»‡ admin.');
        } else {
          alert('âŒ Lá»—i khi xÃ³a chi phÃ­: ' + errorMessage);
        }
        
        // QUAN TRá»ŒNG: LuÃ´n luÃ´n reload data Ä‘á»ƒ Ä‘á»“ng bá»™ vá»›i Firebase
        console.log('ğŸ”„ CRITICAL: Reloading all data to sync with Firebase...');
        try {
          this.expenses = await this.loadExpenses();
          this.settlements = await this.loadSettlements();
          this.updateAll();
          console.log('âœ… Data reloaded successfully after error');
        } catch (reloadError) {
          console.error('âŒ CRITICAL: Failed to reload data after error:', reloadError);
          alert('âŒ Lá»–I NGHIÃŠM TRá»ŒNG: KhÃ´ng thá»ƒ Ä‘á»“ng bá»™ dá»¯ liá»‡u. Vui lÃ²ng refresh trang!');
        }
      }
    }
  }

  private showLoginModal() {
    const loginModal = new LoginModal(
      async (credentials) => {
        try {
          const authState = await this.authService.login(credentials);
          
          // TRIPLE CHECK in main.ts
          console.log('ğŸ”¥ğŸ”¥ğŸ”¥ MAIN.TS FINAL CHECK ğŸ”¥ğŸ”¥ğŸ”¥');
          console.log('ğŸ”¥ Main.ts: authState.currentUser?.isActive:', authState.currentUser?.isActive);
          
          if (authState.currentUser?.isActive !== true) {
            console.error('ğŸš«ğŸš«ğŸš« MAIN.TS FINAL BLOCK ğŸš«ğŸš«ğŸš«');
            alert('ğŸš« MAIN.TS BLOCK: User not active');
            throw new Error('User not active in main.ts check');
          }
          
          this.currentUser = authState.currentUser;
          await this.initializeData();
          this.addExpenseModal = new AddExpenseModal(this.users, this.currentUser, (expense: Expense) => this.addExpense(expense));
          this.render();
          this.setupEventListeners();
          
          // Remove login modal
          document.getElementById('login-modal')?.remove();
        } catch (error) {
          throw error; // Let LoginModal handle the error display
        }
      },
      () => {
        // Close modal
        document.getElementById('login-modal')?.remove();
      }
    );

    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', loginModal.render());
    loginModal.setupEventListeners();
  }

  private logout() {
    if (confirm('ğŸšª Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n Ä‘Äƒng xuáº¥t khÃ´ng?')) {
      this.authService.logout();
      this.currentUser = null;
      this.users = [];
      this.expenses = [];
      this.render();
      this.setupEventListeners();
    }
  }

  private async showUserManagementModal() {
    const users = await this.authService.getAllUsers();
    const userManagementModal = new UserManagementModal(
      users,
      async (userData) => {
        return await this.authService.createUser(userData);
      },
      async (userId, isActive) => {
        await this.authService.updateUser(userId, { isActive });
        // Update local users list
        await this.initializeData();
        this.addExpenseModal = new AddExpenseModal(this.users, this.currentUser, (expense: Expense) => this.addExpense(expense));
      },
      () => {
        // Close modal
        document.getElementById('user-management-modal')?.remove();
      },
      this.authService
    );

    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', userManagementModal.render());
    userManagementModal.setupEventListeners();
  }

  private async editUser(userId: string) {
    // Find the currently open user management modal
    const userManagementModal = document.querySelector('#user-management-modal');
    if (userManagementModal) {
      // Get the UserManagementModal instance from the modal's data attribute or create a new one
      const users = await this.authService.getAllUsers();
      const modal = new UserManagementModal(
        users,
        async (userData) => await this.authService.createUser(userData),
        async (userId, isActive) => {
          await this.authService.updateUser(userId, { isActive });
        },
        () => {},
        this.authService
      );
      modal.editUser(userId);
    }
  }

  private updateAll() {
    this.updateBalanceSection();
    this.updateSettlementSection();
    this.updateExpensesList();
    this.updateStatsCards();
  }

  private updateBalanceSection() {
    const balanceSection = document.getElementById('balanceSection');
    if (balanceSection) {
      balanceSection.innerHTML = this.renderBalanceSection();
    }
  }

  private updateSettlementSection() {
    const settlementSection = document.getElementById('settlementSection');
    if (settlementSection) {
      settlementSection.innerHTML = this.renderSettlementSection();
    }
  }

  private updateExpensesList() {
    const expensesList = document.getElementById('expensesList');
    if (expensesList) {
      expensesList.innerHTML = this.renderExpensesList();
    }
  }

  private updateStatsCards() {
    const statsContainer = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-3');
    if (statsContainer) {
      statsContainer.innerHTML = this.renderStatsCards();
    }
  }

  private updateFilterControls() {
    const clearFilterBtn = document.getElementById('clearFilter');
    if (clearFilterBtn) {
      if (this.currentFilter) {
        clearFilterBtn.classList.remove('hidden');
      } else {
        clearFilterBtn.classList.add('hidden');
      }
    }
  }

  private async confirmSettlement(settlementId: string) {
    try {
      // Kiá»ƒm tra xem settlement cÃ³ tá»“n táº¡i vÃ  user cÃ³ quyá»n confirm khÃ´ng
      const settlement = this.settlements.find(s => s.id === settlementId);
      if (!settlement) {
        alert('âŒ KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin thanh toÃ¡n!');
        return;
      }

      // Chá»‰ ngÆ°á»i nháº­n tiá»n má»›i cÃ³ thá»ƒ confirm
      if (!this.currentUser || this.currentUser.id !== settlement.to) {
        alert('âŒ Chá»‰ ngÆ°á»i nháº­n tiá»n má»›i cÃ³ thá»ƒ xÃ¡c nháº­n thanh toÃ¡n!');
        return;
      }

      console.log('ğŸ”¥ Confirming settlement:', settlementId);
      
      // Cáº­p nháº­t status trong Firebase
      await firebaseService.updateSettlementStatus(settlementId, true);
      
      // Cáº­p nháº­t local data
      const settlementIndex = this.settlements.findIndex(s => s.id === settlementId);
      if (settlementIndex !== -1) {
        this.settlements[settlementIndex].isSettled = true;
        this.settlements[settlementIndex].settledAt = new Date();
      }

      // Re-render UI
      this.render();
      
      alert('âœ… ÄÃ£ xÃ¡c nháº­n thanh toÃ¡n thÃ nh cÃ´ng!');
      
    } catch (error) {
      console.error('âŒ Failed to confirm settlement:', error);
      throw error;
    }
  }

  private async confirmMultipleSettlements(settlementIds: string) {
    try {
      const ids = settlementIds.split(',');
      console.log('ğŸ”¥ Confirming multiple settlements:', ids);
      
      // Kiá»ƒm tra táº¥t cáº£ settlements cÃ³ tá»“n táº¡i vÃ  user cÃ³ quyá»n confirm khÃ´ng
      const settlementsToConfirm = this.settlements.filter(s => ids.includes(s.id));
      
      if (settlementsToConfirm.length !== ids.length) {
        alert('âŒ KhÃ´ng tÃ¬m tháº¥y má»™t sá»‘ thÃ´ng tin thanh toÃ¡n!');
        return;
      }

      // Kiá»ƒm tra quyá»n confirm cho táº¥t cáº£ settlements
      for (const settlement of settlementsToConfirm) {
        if (!this.currentUser || this.currentUser.id !== settlement.to) {
          alert('âŒ Chá»‰ ngÆ°á»i nháº­n tiá»n má»›i cÃ³ thá»ƒ xÃ¡c nháº­n thanh toÃ¡n!');
          return;
        }
      }

      // Cáº­p nháº­t tá»«ng settlement trong Firebase
      for (const settlementId of ids) {
        await firebaseService.updateSettlementStatus(settlementId, true);
        
        // Cáº­p nháº­t local data
        const settlementIndex = this.settlements.findIndex(s => s.id === settlementId);
        if (settlementIndex !== -1) {
          this.settlements[settlementIndex].isSettled = true;
          this.settlements[settlementIndex].settledAt = new Date();
        }
      }

      // Re-render UI
      this.render();
      
      alert(`âœ… ÄÃ£ xÃ¡c nháº­n ${ids.length} khoáº£n thanh toÃ¡n thÃ nh cÃ´ng!`);
      
    } catch (error) {
      console.error('âŒ Failed to confirm multiple settlements:', error);
      throw error;
    }
  }

  private calculateBalancesWithSettlements(): Record<string, any> {
    // TÃ­nh balance tá»« expenses nhÆ° bÃ¬nh thÆ°á»ng
    const balances = calculateBalances(this.expenses, this.users);
    
    // Trá»« Ä‘i nhá»¯ng khoáº£n Ä‘Ã£ thanh toÃ¡n (settlements settled)
    const settledSettlements = this.settlements.filter(s => s.isSettled);
    
    settledSettlements.forEach(settlement => {
      const fromUserId = settlement.from;
      const toUserId = settlement.to;
      const amount = settlement.amount;
      
      // Trá»« sá»‘ tiá»n Ä‘Ã£ thanh toÃ¡n khá»i balance
      if (balances[fromUserId] && balances[fromUserId].owes[toUserId]) {
        balances[fromUserId].owes[toUserId] -= amount;
        if (balances[fromUserId].owes[toUserId] <= 0) {
          delete balances[fromUserId].owes[toUserId];
        }
      }
      
      if (balances[toUserId] && balances[toUserId].owedBy[fromUserId]) {
        balances[toUserId].owedBy[fromUserId] -= amount;
        if (balances[toUserId].owedBy[fromUserId] <= 0) {
          delete balances[toUserId].owedBy[fromUserId];
        }
      }
    });
    
    // TÃ­nh láº¡i totals
    Object.keys(balances).forEach(userId => {
      balances[userId].totalOwes = Object.values(balances[userId].owes).reduce((sum: number, amount: any) => sum + amount, 0);
      balances[userId].totalOwed = Object.values(balances[userId].owedBy).reduce((sum: number, amount: any) => sum + amount, 0);
    });
    
    return balances;
  }


}

// Initialize the app
new SplitwiseApp();